## Automated HSpeak tests. See documentation in hspeaktest.py
## Run these tests with "scons hspeaktest -j4"

## Including just this is faster than all of plotscr.hsd
include, hamsterspeak.hsd

define function, begin
  1,noop4,4,0,0,0,0
end

globalvariable(1,globalvar)
defineconstant(1,constant)

## Check for errors given extra commas, and for operators in illegal positions
script, comma tests, begin
  variable(xx)
  +,                     # ERROR
  + ,                    # ERROR
  <<,                    # ERROR
  << ,                   # ERROR
  ,<<1                   # ERROR
  , <<2                  # ERROR
  ,<3                    # ERROR
  , <4                   # ERROR
  1,-2                   # WARN
  ,-2                    # WARN
  -2,                    # WARN
  noop4(1,-2)            # OK
  1,:=2                  # ERROR
  1,--2                  # ERROR
  2--1                   # WARN
  ## FIXME: This is major lexer bug
  2-1                    # ERROR
  noop4(1,mod,2)         # OK
  #if,(xx) then()         # WARN
  if(xx), then()         # OK
  #if(xx) then,()         # WARN
  noop4((1), (2))        # OK
  noop4(-2)              # OK
  noop4((2) -- (1))      # OK
  ## These error checks aren't implemented; they're hard to catch
  noop(),                # ERROR
  noop,()                # ERROR
  noop4(noop,())         # ERROR
  ## This fails because parsed as noop(0), but noop takes no args
  ## Let's say this should be a warning, because the behaviour would have changed
  noop4(noop,(0))        # WARN
  noop4( --2)            # ERROR
  noop4(,--2)            # ERROR
  noop4( ,  , 0)         # ERROR
  noop4( , 0)            # ERROR
  ## This probably doesn't particularly need to be disallowed
  noop4(0 ,)             # OK
  ## $ is treated as a unary operator
  $,0=""                 # ERROR
  $0,=""                 # ERROR
  $0=,""                 # ERROR
  noop4($0="")           # OK
  noop4(1,$0="")         # OK
  noop4(,$0="")          # ERROR
end

script, string tests, begin
  $0="", 232             # WARN
  $0="" 232              # ERROR
  "asdasd"               # ERROR
end

script, flow tests, dummy, begin
  if(dummy) then() else()
  else()                 # ERROR
  then()                 # ERROR
  break                  # ERROR
  continue               # ERROR
  if () then()           # ERROR
  if(dummy,dummy) then() # ERROR
  if(dummy) if(dummy) then() # ERROR
  if(dummy) else()           # OK
  if(dummy) else() then()    # ERROR
end

script, namespace tests, arg, begin
  variable(noop)         # ERROR
  variable(script)       # ERROR
  variable(globalvar)    # ERROR
  variable(constant)     # ERROR
  variable(flow tests)   # ERROR
  variable(arg)          # ERROR
  variable(1)            # ERROR
  variable(a.)           # ERROR
  variable(v)
  ## subscript args and variables can shadow outer locals, but not globals
  subscript, sub ()                               # OK
  subscript, sub, globalvar ()                    # ERROR
  subscript, sub, constant ()                     # ERROR
  subscript, sub, NO OP ()                        # ERROR
  subscript, sub, namespace tests ()              # ERROR
  subscript, sub, sub ()                          # ERROR
  subscript, sub, arg ()                          # OK
  subscript, sub, v ()                            # OK
  subscript, namespace tests, arg ()              # ERROR
  subscript, sub, (subscript, sub2 ())            # OK
  subscript, sub, (subscript, SUB ())             # ERROR
  subscript, sub, (subscript, namespace tests ()) # ERROR
  subscript, sub, v (subscript, sub2, v ())       # OK
  subscript, sub, W (subscript, sub2, w ())       # OK
end
